<!DOCTYPE html>
<html>
	<head>
		<title>Test Grid Store Observation</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta name="viewport" content="width=570" />
		<style type="text/css">
			@import "../../dojo/resources/dojo.css";
			@import "../../dijit/themes/claro/claro.css";
			@import "../css/skins/claro.css";
			
			.ui-widget {
				margin: 10px;
			}
			
			.dgrid-grid {
				width: 700px;
			}
			.dgrid-list {
				width: 200px;
			}
			
			#grid2 {
				width: 500px;
				float: left;
			}
			#grid3 {
				width: 500px;
				float: right;
			}
			
			.dgrid .field-bool {
				width: 6em;
			}
			.dgrid .field-type {
				width: 80px;
			}
			
			#grid2 .field-date, #grid2 .field-date2 {
				width: 16em;
			}
			#grid2 .field-integer {
				width: 6em;
			}
			#grid2 .field-bool { /* checkbox */
				width: 4em;
			}
			#save {
				display:block;
				clear:both;
				margin-bottom: 20px;
			}
			
			#gridAddDel, #listAddDel {
				float: left;
			}
		</style>
		<script>
			var start= new Date().getTime();
		</script>
		<script type="text/javascript" src="../../dojo/dojo.js" 
			data-dojo-config="async: true"></script>
		<script type="text/javascript">
			require(["dojo/on", "dgrid/OnDemandList", "dgrid/OnDemandGrid","dgrid/Keyboard", "dgrid/Selection", "dgrid/Editor", "dijit/form/DateTextBox", "dijit/form/HorizontalSlider", "dijit/form/NumberSpinner",  "dgrid/test/data", "dojo/_base/lang", "dojo/dom-construct", "dojo/store/Memory", "dojo/domReady!"],
				function(on, List, Grid, Keyboard, Selection, Editor, DateTextBox, Slider, NumberSpinner, data, lang, domConstruct, Memory){
					
					// Create error store
					errorStore = new dojo.store.Memory();
					errorStore.query = function() {
						throw new Error("Some Error");
					};
					
					// Create error store with PUT
					putErrorStore = new dojo.store.Memory({ data: lang.clone(testTypesStore.data) });
					putErrorStore.put = function() {
						throw new Error("PUT ERROR");
					};
					
					// Create error store that has its deferred rejected
					defErrorStore = new dojo.store.Memory();
					defErrorStore.query = function() {
						var def = new dojo.Deferred();
						setTimeout(function() { def.reject("Homie don't play that"); }, 200);
						return def.promise;
					};
					
					// Create error store that returns a promise on put, which it rejects
					defPutErrorStore = new dojo.store.Memory({ data: lang.clone(testTypesStore.data) });
					defPutErrorStore.put = function() {
						var def = new dojo.Deferred();
						setTimeout(function() { def.reject("Watch where you put things!"); }, 200);
						return def.promise;
					};
					
					var columns = {
						col1: 'Column 1',
						col2: {label: 'Column 2'},
						col3: 'Column 3',
						col4: 'Column 4',
						col5: 'Column 5',
						col6: 'Column 6',
						"last-col": {label: 'Column 7', field: 'col7'}
					};

					var columns2 = [
						Editor({label: 'Real Number', field: 'floatNum'}, Slider),
						Editor({label: 'Integer', field: 'integer', widgetArgs: {style: 'width: 5em;'}}, NumberSpinner),
						Editor({label: 'Text editable if checkbox checked', field: 'text', canEdit: function(object){
							return object.bool;
						}}, "text", "dblclick"),
						Editor({label: 'Another Date (autoSave)', field: 'date2', autoSave:true}, DateTextBox, "focus"),
						Editor({label: 'Check', field: 'bool'}, "checkbox")
					];

					var columns3 = {
						floatNum: 'Real Number',
						integer: 'Integer',
						text: 'Text',
						date2: 'Date',
						bool: 'Check'
					};
					var columns4 = {
						col1: 'Color',
						col2: 'A Goat',
						col3: 'Position',
						col4: 'Description',
						col5: 'R',
						col6: 'G',
						"last-col": {label: 'B', field: 'col7'}
					};
					window.grid = dojo.declare([Grid])({
						store: testStore,
						columns: columns
					}, "grid");

					window.grid2 = dojo.declare([Grid, Selection, Keyboard])({
						store: testTypesStore,
						columns: columns2,
						selectionMode: "single"
					},"grid2");

					window.grid3 = dojo.declare([Grid, Keyboard])({
						store: testTypesStore,
						columns: columns3
					}, "grid3");

					window.gridAddDel = dojo.declare([Grid, Keyboard, Selection])({
						store: smallColorStore,
						columns: columns4,
						selectionMode: "multiple"
					}, "gridAddDel");
					
					// also throw in a List connected to the same store
					// (so additions/deletions should show up in both)
					window.listAddDel = dojo.declare([List, Keyboard, Selection])({
						store: smallColorStore,
						columns: columns4,
						selectionMode: "multiple",
						renderRow: function(object, options){
							// need to define renderRow to accommodate store items
							return domConstruct.create("div", {
								innerHTML: object.col1
							});
						}
					}, "listAddDel");
					
					// buttons for 1st grid
					
					on(document.getElementById("setstore"), "click", function(){
						console.log("setting store to colorStore: ", colorStore);
						window.grid.setStore(colorStore);//no query
					});
					on(document.getElementById("restore"), "click", function(){
						console.log("setting store to testStore");
						grid.setStore(testStore);//no query
					});
					on(document.getElementById("colorQuery"), "click", function(){
						console.log("setting store to colorStore and setting query to show only primary colors");
						grid.setStore(colorStore, {col3: "Primary"});//query set to only show primary colors
					});
					on(document.getElementById("resetQuery"), "click", function(){
						console.log("reset query to show all");
						grid.setQuery({});
					});
					
					var sortDescending = true;
					
					on(document.getElementById("setQueryWithOptions"), "click", function(){
						// set sortOrder for the col1 field
						sortDescending ^= 1; // toggle true/false
					
						// get an existing sortOrder
						var sortByCol1 = dojo.filter(
								grid.sortOrder || [], 
								function(sortBy){
									return sortBy.attribute == "col1";
								}
						).shift();
						if(sortByCol1){
							console.log("modifying existing sortOrder for col1: ", sortByCol1);
						} else {
							sortByCol1 = { attribute: "col1" };
						}
						sortByCol1.descending = sortDescending;
						grid.setQuery(grid.query, { sort: [sortByCol1] });
					});
					on(document.getElementById("sort"), "click", function(){
						console.log("sortOrder: ", grid.sortOrder);
						
						sortDescending ^= 1; // toggle true/false
						grid.sort("col1", sortDescending);
					});


					on(document.getElementById("empty"), "click", function(){
						console.log("set store to emptyStore");
						grid.setStore(emptyStore, {});
					});
					on(document.getElementById("error"), "click", function(){
						console.log("set store to errorStore");
						grid.setStore(errorStore,{});
					});
					
					on(document.getElementById("error2"), "click", function(){
						console.log("set store to defErrorStore");
						grid.setStore(defErrorStore,{});
					});
					
					// buttons / listeners for 2nd grid
					
					on(document.getElementById("save"), "click", function(){
						console.log("save to store");
						grid2.save();
						domConstruct.empty("dirty");
					});
					
					on(document.getElementById("setorigeditstore"), "click", function(){
						grid2.setStore(testTypesStore, {});
						domConstruct.empty("dirty");
					});
					
					on(document.getElementById("seterrorputstore"), "click", function(){
						grid2.setStore(putErrorStore, {});
						domConstruct.empty("dirty");
					});
					
					on(document.getElementById("setdeferrorputstore"), "click", function(){
						grid2.setStore(defPutErrorStore, {});
						domConstruct.empty("dirty");
					});
					
					var dirtyListener = grid2.on("datachange", function(event){
						setTimeout(function(){
							// clear "dirty items" list after change has been processed
							domConstruct.empty("dirty");
							for(var rowId in grid2.dirty){
								var node = domConstruct.create("div",
									{ innerHTML: "rowId: "+rowId }, "dirty");
							}
						}, 0);
					});
					
					// buttons for 3rd grid
					
					on(document.getElementById("add"), "click", function(){
						var id = smallColorStore.data.length+Math.floor(Math.random()*1001);
						console.log("id: ", id);
						smallColorStore.put({id: id, col1: "Grey", col2: false, col3: "Hue", col4:'A hue' , col5: 192, col6: 192, col7: 192 });
					});
					on(document.getElementById("delete"), "click", function(){
						for(var id in gridAddDel.selection){
							smallColorStore.remove(id);
						}
					});
				});
		</script>
	</head>
	<body class="claro">
		<h2>Simple test to show setting a new store and query to dgrid</h2>
		<div id="grid"></div>
		<button id="setstore">Set Color Store</button>
		<button id="restore">Set Original Store</button>
		<button id="colorQuery">Set color store and query</button>
		<button id="resetQuery">Reset query</button>
		<button id="setQueryWithOptions">Set query with queryOptions</button>
		<button id="sort">sort</button>
		<button id="empty">Set to empty store</button>
		<button id="error">Set to error store</button>
		<button id="error2">Set to error store (def)</button>

		<br><br>
		<h2>Simple test to show editor effect on store data</h2>
		<div id="container" style="width:1200px;">
		<div id="grid2"></div>
		<div style="float:left;margin-left:20px;"><div><h3>Dirty Items</h3></div><div id="dirty"></div></div>
		<div id="grid3"></div>
		</div>
		<button id="save">Save Changes</button>
		<button id="setorigeditstore">Set to original store</button>
		<button id="seterrorputstore">Set to store which causes error on put</button>
		<button id="setdeferrorputstore">Set to store which rejects Deferred on put</button>
		<br>
		<h2>Simple test to show adding/deleting items</h2>
		<p>(With an OnDemandList alongside, also observing the changes)</p>
		<div id="gridAddDel"></div>
		<div id="listAddDel"></div>
		<div style="clear:both">
			<button id="add">Add Color</button>
			<button id="delete">Delete Selected</button>
		</div>
	</body>
</html>
